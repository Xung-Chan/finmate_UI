<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/ibanking_kltn/ui/screens/ekyc/MIGRATION.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/ibanking_kltn/ui/screens/ekyc/MIGRATION.md" />
              <option name="updatedContent" value="#  HOÀN TẤT: Cấu trúc lại eKYC theo MVI/MVVM&#10;&#10;## ✅ Đã thực hiện&#10;&#10;### 1. **Tạo cấu trúc thư mục mới**&#10;```&#10;ui/screens/ekyc/&#10;├── EkycIntent.kt       ✅ Các Intent (user actions)&#10;├── EkycUiState.kt      ✅ State management &amp; data classes&#10;├── EkycViewModel.kt    ✅ Business logic &amp; data processing&#10;├── EkycScreen.kt       ✅ UI Composables&#10;└── README.md           ✅ Documentation&#10;```&#10;&#10;### 2. **Refactor MainActivity**&#10;- ✅ Comment out old eKYC code&#10;- ✅ Sử dụng `EkycScreen` mới&#10;- ✅ Xóa các import không cần thiết&#10;- ✅ Clean code&#10;&#10;### 3. **Implement MVI Pattern**&#10;```&#10;User Action → Intent → ViewModel → State → UI&#10;```&#10;&#10;##  So sánh Before/After&#10;&#10;### ❌ BEFORE (Old Architecture):&#10;```kotlin&#10;// MainActivity.kt - Everything in one file&#10;class MainActivity : FragmentActivity() {&#10;    // 500+ lines of code&#10;    private val fullEkycLauncher = ...&#10;    private fun openCameraFullProOval() { ... }&#10;    private fun logEkycResult() { ... }&#10;    private fun parseOcrData() { ... }&#10;    // No separation of concerns&#10;    // Hard to test&#10;    // Difficult to maintain&#10;}&#10;```&#10;&#10;### ✅ AFTER (MVI/MVVM Architecture):&#10;```kotlin&#10;// MainActivity.kt - Clean &amp; Simple&#10;class MainActivity : FragmentActivity() {&#10;    override fun onCreate(savedInstanceState: Bundle?) {&#10;        setContent {&#10;            EkycScreen(&#10;                onNavigateBack = { finish() },&#10;                onEkycComplete = { ocrData, faceResult -&gt; &#10;                    // Handle result&#10;                }&#10;            )&#10;        }&#10;    }&#10;}&#10;&#10;// EkycViewModel.kt - Business Logic&#10;@HiltViewModel&#10;class EkycViewModel @Inject constructor() : ViewModel() {&#10;    val uiState: StateFlow&lt;EkycUiState&gt;&#10;    fun handleIntent(intent: EkycIntent)&#10;    fun handleEkycResult(resultCode: Int, data: Intent?)&#10;}&#10;&#10;// EkycScreen.kt - UI Layer&#10;@Composable&#10;fun EkycScreen(&#10;    viewModel: EkycViewModel = hiltViewModel(),&#10;    onNavigateBack: () -&gt; Unit,&#10;    onEkycComplete: (OcrData, FaceCompareResult?) -&gt; Unit&#10;) { /* Compose UI */ }&#10;```&#10;&#10;##  Lợi ích đạt được&#10;&#10;### 1. **Separation of Concerns** ✨&#10;- **UI Layer** (EkycScreen.kt) - Chỉ hiển thị&#10;- **Business Logic** (EkycViewModel.kt) - Xử lý dữ liệu&#10;- **State** (EkycUiState.kt) - Single source of truth&#10;- **Actions** (EkycIntent.kt) - User interactions&#10;&#10;### 2. **Testability** &#10;```kotlin&#10;// Test ViewModel độc lập&#10;@Test&#10;fun testStartEkyc() {&#10;    viewModel.handleIntent(EkycIntent.StartFullEkyc)&#10;    assertEquals(EkycStep.Initial, viewModel.uiState.value.ekycStep)&#10;}&#10;&#10;// Preview UI với mock data&#10;@Preview&#10;@Composable&#10;fun PreviewCompletedState() {&#10;    EkycScreen(viewModel = MockEkycViewModel())&#10;}&#10;```&#10;&#10;### 3. **Maintainability** &#10;- Code rõ ràng, dễ đọc&#10;- Dễ thêm tính năng mới&#10;- Dễ fix bug&#10;&#10;### 4. **Scalability** &#10;- Dễ dàng thêm:&#10;  - Repository layer&#10;  - UseCase layer&#10;  - More UI states&#10;  - Analytics tracking&#10;&#10;### 5. **Type Safety** ️&#10;- Strongly typed intents&#10;- Sealed interfaces&#10;- Compile-time checking&#10;&#10;##  Cách sử dụng mới&#10;&#10;### Cách cũ (Deprecated):&#10;```kotlin&#10;// MainActivity.kt&#10;private val fullEkycLauncher = registerForActivityResult(...) { ... }&#10;private fun openCameraFullProOval() { &#10;    val intent = Intent(...)&#10;    // 50+ lines of configuration&#10;    fullEkycLauncher.launch(intent)&#10;}&#10;```&#10;&#10;### Cách mới (Recommended):&#10;```kotlin&#10;// Anywhere in your app&#10;EkycScreen(&#10;    onNavigateBack = { navController.popBackStack() },&#10;    onEkycComplete = { ocrData, faceResult -&gt;&#10;        // ✅ Strongly typed result&#10;        Log.d(&quot;eKYC&quot;, &quot;Name: ${ocrData.name}&quot;)&#10;        Log.d(&quot;eKYC&quot;, &quot;ID: ${ocrData.id}&quot;)&#10;        Log.d(&quot;eKYC&quot;, &quot;Matched: ${faceResult?.isMatched}&quot;)&#10;        &#10;        // Navigate to next screen or save data&#10;        navController.navigate(&quot;success&quot;)&#10;    }&#10;)&#10;```&#10;&#10;##  Migration Guide&#10;&#10;### Nếu bạn đang sử dụng code cũ:&#10;&#10;#### Bước 1: Import new package&#10;```kotlin&#10;import com.example.ibanking_kltn.ui.screens.ekyc.EkycScreen&#10;import com.example.ibanking_kltn.ui.screens.ekyc.OcrData&#10;import com.example.ibanking_kltn.ui.screens.ekyc.FaceCompareResult&#10;```&#10;&#10;#### Bước 2: Replace old code&#10;```kotlin&#10;// Xóa&#10;// private val fullEkycLauncher = ...&#10;// private fun openCameraFullProOval() { ... }&#10;&#10;// Thay bằng&#10;setContent {&#10;    EkycScreen(&#10;        onNavigateBack = { finish() },&#10;        onEkycComplete = { ocrData, faceResult -&gt;&#10;            // Your logic here&#10;        }&#10;    )&#10;}&#10;```&#10;&#10;#### Bước 3: Handle result&#10;```kotlin&#10;onEkycComplete = { ocrData, faceCompareResult -&gt;&#10;    // Save to database&#10;    viewModel.saveEkycResult(ocrData)&#10;    &#10;    // Or send to server&#10;    apiService.uploadEkycData(ocrData)&#10;    &#10;    // Or navigate&#10;    navController.navigate(&quot;home&quot;)&#10;}&#10;```&#10;&#10;##  Các lỗi đã fix&#10;&#10;### 1. ✅ COMPARE_FACE_RESULT trả về NULL&#10;**Fix:** Thêm `IS_ENABLE_COMPARE = true` trong intent configuration&#10;&#10;### 2. ✅ Bad Base-64 error&#10;**Fix:** Bỏ qua decode `dataBase64`, parse từ `object` field thay vì&#10;&#10;### 3. ✅ Code quá phức tạp trong MainActivity&#10;**Fix:** Refactor thành MVI/MVVM architecture&#10;&#10;### 4. ✅ Khó test và maintain&#10;**Fix:** Separation of concerns, single responsibility&#10;&#10;##  Files quan trọng&#10;&#10;### 1. **EkycViewModel.kt**&#10;- Parse OCR data từ JSON&#10;- Parse face compare result&#10;- Parse liveness results&#10;- Handle errors gracefully&#10;- Comprehensive logging&#10;&#10;### 2. **EkycScreen.kt**&#10;- Jetpack Compose UI&#10;- Permission handling&#10;- Activity Result Launchers&#10;- Multiple UI states&#10;- Helper functions for intent creation&#10;&#10;### 3. **EkycUiState.kt**&#10;- Data classes for all eKYC data&#10;- UI State with loading, error, success states&#10;- EkycStep enum for flow tracking&#10;&#10;### 4. **EkycIntent.kt**&#10;- Sealed interface for type-safe actions&#10;- All possible user interactions&#10;&#10;##  Next Steps&#10;&#10;### Recommended improvements:&#10;&#10;#### 1. **Add Repository**&#10;```kotlin&#10;@HiltViewModel&#10;class EkycViewModel @Inject constructor(&#10;    private val ekycRepository: EkycRepository //  Add this&#10;) : ViewModel()&#10;```&#10;&#10;#### 2. **Add UseCase**&#10;```kotlin&#10;class SubmitEkycDataUseCase @Inject constructor(&#10;    private val repository: EkycRepository&#10;) {&#10;    suspend operator fun invoke(ocrData: OcrData): Result&lt;Unit&gt;&#10;}&#10;```&#10;&#10;#### 3. **Add Analytics**&#10;```kotlin&#10;fun handleIntent(intent: EkycIntent) {&#10;    analytics.logEvent(&quot;ekyc_intent&quot;, mapOf(&quot;type&quot; to intent::class.simpleName))&#10;    // ...&#10;}&#10;```&#10;&#10;#### 4. **Add Error Recovery**&#10;```kotlin&#10;sealed class EkycError {&#10;    data class NetworkError(val message: String) : EkycError()&#10;    data class SdkError(val code: Int) : EkycError()&#10;    data class ValidationError(val field: String) : EkycError()&#10;}&#10;```&#10;&#10;#### 5. **Add Loading States**&#10;```kotlin&#10;enum class LoadingState {&#10;    Idle,&#10;    LaunchingSdk,&#10;    ProcessingImages,&#10;    ComparingFaces,&#10;    UploadingData,&#10;    Completed&#10;}&#10;```&#10;&#10;##  Documentation&#10;&#10;Xem chi tiết tại: `ui/screens/ekyc/README.md`&#10;&#10;## ✨ Kết luận&#10;&#10;```&#10;╔═══════════════════════════════════════════════════════════╗&#10;║  ✅ Migration to MVI/MVVM COMPLETED!                     ║&#10;║                                                           ║&#10;║   4 new files created                                  ║&#10;║   MainActivity cleaned up                              ║&#10;║  ️ MVI Architecture implemented                         ║&#10;║   Documentation added                                  ║&#10;║   All bugs fixed                                       ║&#10;║                                                           ║&#10;║  Ready to use!                                         ║&#10;╚═══════════════════════════════════════════════════════════╝&#10;```&#10;&#10;---&#10;&#10;**Migration Date:** February 12, 2026  &#10;**Status:** ✅ COMPLETED  &#10;**Architecture:** MVI/MVVM  &#10;**Framework:** Jetpack Compose + Hilt&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/ibanking_kltn/ui/screens/ekyc/README.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/ibanking_kltn/ui/screens/ekyc/README.md" />
              <option name="updatedContent" value="# eKYC Module - Cấu trúc MVI/MVVM&#10;&#10;##  Cấu trúc thư mục&#10;&#10;```&#10;ui/screens/ekyc/&#10;├── EkycIntent.kt       - Các Intent (hành động người dùng)&#10;├── EkycUiState.kt      - UI State và Data classes&#10;├── EkycViewModel.kt    - ViewModel xử lý business logic&#10;└── EkycScreen.kt       - UI Composable screen&#10;```&#10;&#10;## ️ Kiến trúc MVI/MVVM&#10;&#10;### 1. **EkycIntent.kt** - User Actions&#10;Định nghĩa tất cả các hành động người dùng có thể thực hiện:&#10;- `StartFullEkyc` - Bắt đầu eKYC đầy đủ (CCCD + Face)&#10;- `StartFaceCapture` - Chỉ chụp khuôn mặt&#10;- `CancelEkyc` - Hủy bỏ&#10;- `RetryEkyc` - Thử lại&#10;- `ConfirmOcrData` - Xác nhận dữ liệu OCR&#10;- `DismissError` - Đóng thông báo lỗi&#10;&#10;### 2. **EkycUiState.kt** - State Management&#10;Chứa tất cả state của UI và data classes:&#10;&#10;#### Data Classes:&#10;- `OcrData` - Thông tin từ CCCD/CMND&#10;- `FaceCompareResult` - Kết quả so sánh khuôn mặt&#10;- `LivenessResult` - Kết quả kiểm tra liveness&#10;- `EkycImages` - Đường dẫn và hash của ảnh&#10;&#10;#### UI State:&#10;```kotlin&#10;data class EkycUiState(&#10;    val isLoading: Boolean,&#10;    val ekycStep: EkycStep,&#10;    val ocrData: OcrData?,&#10;    val faceCompareResult: FaceCompareResult?,&#10;    val errorMessage: String?,&#10;    // ...&#10;)&#10;```&#10;&#10;#### EkycStep Enum:&#10;- `Initial` - Chưa bắt đầu&#10;- `FrontCard` - Chụp mặt trước&#10;- `BackCard` - Chụp mặt sau&#10;- `FaceCapture` - Chụp khuôn mặt&#10;- `Processing` - Đang xử lý&#10;- `ReviewData` - Xem lại dữ liệu&#10;- `Completed` - Hoàn tất&#10;- `Failed` - Thất bại&#10;&#10;### 3. **EkycViewModel.kt** - Business Logic&#10;ViewModel xử lý:&#10;- Nhận Intent từ UI&#10;- Xử lý kết quả từ VNPT SDK&#10;- Parse OCR data, face compare result, liveness result&#10;- Cập nhật UI State&#10;- Logging chi tiết&#10;&#10;#### Key Methods:&#10;```kotlin&#10;fun handleIntent(intent: EkycIntent)&#10;fun handleEkycResult(resultCode: Int, data: Intent?)&#10;private fun parseOcrData(data: Intent): OcrData?&#10;private fun parseFaceCompareResult(data: Intent): FaceCompareResult?&#10;```&#10;&#10;### 4. **EkycScreen.kt** - UI Layer&#10;Composable screen với:&#10;- Activity Result Launchers (Full eKYC, Face Only)&#10;- Permission handling&#10;- UI State observation&#10;- Multiple UI states:&#10;  - `InitialContent` - Chọn loại xác thực&#10;  - `LoadingContent` - Đang xử lý&#10;  - `CompletedContent` - Hoàn tất thành công&#10;  - `ReviewDataContent` - Xem lại dữ liệu&#10;  - `ErrorContent` - Hiển thị lỗi&#10;&#10;##  Data Flow&#10;&#10;```&#10;User Action (UI)&#10;    ↓&#10;EkycIntent&#10;    ↓&#10;EkycViewModel.handleIntent()&#10;    ↓&#10;Launch VNPT SDK Activity&#10;    ↓&#10;SDK Result → handleEkycResult()&#10;    ↓&#10;Parse Data (OCR, Face Compare, Liveness)&#10;    ↓&#10;Update UI State&#10;    ↓&#10;UI Re-render (Compose)&#10;```&#10;&#10;##  Cách sử dụng&#10;&#10;### 1. Trong MainActivity hoặc Navigation:&#10;&#10;```kotlin&#10;setContent {&#10;    IBanking_KLTNTheme {&#10;        EkycScreen(&#10;            onNavigateBack = { finish() },&#10;            onEkycComplete = { ocrData, faceCompareResult -&gt;&#10;                // Handle completion&#10;                Log.d(&quot;eKYC&quot;, &quot;Name: ${ocrData.name}&quot;)&#10;                Log.d(&quot;eKYC&quot;, &quot;ID: ${ocrData.id}&quot;)&#10;                Log.d(&quot;eKYC&quot;, &quot;Face matched: ${faceCompareResult?.isMatched}&quot;)&#10;            }&#10;        )&#10;    }&#10;}&#10;```&#10;&#10;### 2. Nhận kết quả eKYC:&#10;&#10;```kotlin&#10;onEkycComplete = { ocrData, faceCompareResult -&gt;&#10;    // ocrData chứa thông tin CCCD&#10;    val name = ocrData.name&#10;    val id = ocrData.id&#10;    val address = ocrData.recentLocation&#10;    &#10;    // faceCompareResult chứa kết quả so sánh&#10;    val isMatched = faceCompareResult?.isMatched ?: false&#10;    val similarity = faceCompareResult?.similarity ?: 0.0&#10;    &#10;    // TODO: Gửi dữ liệu lên server hoặc chuyển màn hình&#10;}&#10;```&#10;&#10;##  Ưu điểm của kiến trúc này&#10;&#10;### ✅ Separation of Concerns&#10;- UI logic tách biệt khỏi business logic&#10;- Dễ test từng layer độc lập&#10;&#10;### ✅ Reactive Programming&#10;- UI tự động cập nhật khi State thay đổi&#10;- Single source of truth (StateFlow)&#10;&#10;### ✅ Type Safety&#10;- Strongly typed intents và states&#10;- Compiler kiểm tra lỗi sớm&#10;&#10;### ✅ Maintainability&#10;- Code dễ đọc, dễ maintain&#10;- Dễ dàng thêm tính năng mới&#10;&#10;### ✅ Testability&#10;- ViewModel có thể test độc lập&#10;- UI có thể preview với mock data&#10;&#10;##  Testing&#10;&#10;### Unit Test ViewModel:&#10;```kotlin&#10;@Test&#10;fun `handleIntent StartFullEkyc should update state to loading`() {&#10;    val viewModel = EkycViewModel()&#10;    viewModel.handleIntent(EkycIntent.StartFullEkyc)&#10;    &#10;    val state = viewModel.uiState.value&#10;    assertEquals(true, state.isLoading)&#10;    assertEquals(EkycStep.Initial, state.ekycStep)&#10;}&#10;```&#10;&#10;### UI Test:&#10;```kotlin&#10;@Test&#10;fun `EkycScreen shows initial content when not started`() {&#10;    composeTestRule.setContent {&#10;        EkycScreen()&#10;    }&#10;    &#10;    composeTestRule.onNodeWithText(&quot;Chọn loại xác thực&quot;).assertIsDisplayed()&#10;}&#10;```&#10;&#10;##  Logging&#10;&#10;ViewModel log chi tiết tất cả kết quả từ SDK:&#10;- OCR_RESULT&#10;- COMPARE_FACE_RESULT&#10;- LIVENESS_FACE_RESULT&#10;- LAST_STEP&#10;- Images paths và hashes&#10;&#10;Xem log với tag: `EkycViewModel`&#10;&#10;##  Configuration&#10;&#10;Cấu hình VNPT SDK trong `EkycScreen.kt`:&#10;- `createFullEkycIntent()` - Full eKYC flow&#10;- `createFaceCaptureIntent()` - Face only flow&#10;&#10;Tokens được lấy từ `BuildConfig`:&#10;- `BuildConfig.VNPT_ACCESS_TOKEN`&#10;- `BuildConfig.VNPT_TOKEN_ID`&#10;- `BuildConfig.VNPT_TOKEN_KEY`&#10;&#10;##  Next Steps&#10;&#10;### Có thể mở rộng:&#10;1. **Repository Layer** - Gọi API lưu kết quả eKYC&#10;2. **UseCase Layer** - Business logic phức tạp hơn&#10;3. **Error Handling** - Custom error types&#10;4. **Analytics** - Track user flow&#10;5. **A/B Testing** - Thử nghiệm UI khác nhau&#10;&#10;##  References&#10;&#10;- [MVI Architecture](https://hannesdorfmann.com/android/model-view-intent/)&#10;- [Jetpack Compose State](https://developer.android.com/jetpack/compose/state)&#10;- [ViewModel](https://developer.android.com/topic/libraries/architecture/viewmodel)&#10;- [Hilt Dependency Injection](https://developer.android.com/training/dependency-injection/hilt-android)&#10;&#10;---&#10;&#10;**Created:** February 12, 2026&#10;**Author:** GitHub Copilot&#10;**Version:** 1.0.0&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>